<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="/static/bootstrap-icons/bootstrap-icons.css">
    <script src="/static/jquery-3.7.1.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/main.css" type="text/css">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <title>{{application_name}}</title>
</head>
<body id="body-element-id" class="container-fluid d-flex position-absolute m-0 p-0">
<div class="container-fluid p-0 m-0">
    <div id="about_us_modal" tabindex="-1" class="modal fade" data-backdrop="static"
         xmlns="http://www.w3.org/1999/html"
         role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" id="about_us_modal_content">
                <div class="modal-header">
                    <h5 class="modal-title">{{application_name}}</h5>
                </div>
                <div class="modal-body">
                    <div class="row mt-2 mb-2">
                        <span><b>Created by Joe Zeitouny</b></span>
                    </div>
                    <div class="row mb-2">
                        <span><b>Version&nbsp {{application_version}}</b></span>
                    </div>
                    <div class="row mb-2">
                        <span><b>Website</b>&nbsp <a href="https://invoicebuddy.site" target="_blank">https://invoicebuddy.site</a></span>
                    </div>
                    <div class="row mb-2">
                        <div id="system_configuration_card" class="card border">
                            <div class="card-body p-0">
                                <form action="/upload_config" method="POST" enctype="multipart/form-data">
                                    <h5 class="card-title">System Configuration</h5>
                                    <div class="mb-2">
                                        <label for="configFormFile" class="form-label">Upload JSON configuration
                                            file</label>
                                        <input class="form-control" type="file" id="configFormFile" name="config_file"
                                               accept=".json">
                                    </div>

                                    <button type="submit" class="btn btn-primary mb-1">Upload Configuration</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div id="seller_logo_card" class="card border">
                            <div class="card-body p-0">
                                <div class="row align-items-center">
                                    <div class="col-9">
                                        <form action="/upload_seller_logo" method="POST" enctype="multipart/form-data">
                                            <h5 class="card-title">Seller Logo</h5>
                                            <div class="mb-2">
                                                <label for="sellerLogoFormFile" class="form-label">Upload new
                                                    logo</label>
                                                <input class="form-control" type="file" id="sellerLogoFormFile"
                                                       name="seller_logo" accept="image/*">
                                            </div>

                                            <button type="submit" class="btn btn-primary mb-1">Upload Logo</button>
                                        </form>
                                    </div>
                                    <div class="col-3 text-center">
                                        Uploaded
                                        <img src="/static/seller-logo.png" alt="Seller Logo"
                                             style="width:100px; height:75px">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="close btn btn-secondary" onclick="hideAboutUsModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row px-0 mx-0">
        <nav id="navbar-element-id" class="navbar navbar-expand-lg bg-dark bg-gradient shadow m-0 p-0">
            <div class="container-fluid p-2">
                <div class="col-auto">
                    <button class="navbar-brand btn" type="button" onclick="showAboutUsModal()">
                        <span><img src="/static/logo.png" alt="..." width="32" height="32"> {{application_name}}</small></span>
                    </button>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNavAltMarkup"
                        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
                            <a class="nav-link text-light" href="/">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="/view_items">Items</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="/view_past_invoices">Past Invoices (<span
                                    id="past_invoices_count"></span>)</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="/view_past_proposals">Past Proposals (<span
                                    id="past_proposals_count"></span>)</a>
                        </li>
                    </ul>
                </div>
                <div class="col-12 col-md-7 col-lg-5 col-xl-4">
                    <span class="row align-items-center justify-content-end pe-1">
                        <div class="col-auto p-1 me-2">
                            <div class="row px-0 mx-0">
                                <span class="px-0 mx-0">
                                    <button class="ms-2 btn btn-secondary" type="submit"
                                            onclick="showNewItemModal()" style="font-size: 0.9rem;">
                                            <span>New Item</span>
                                    </button>
                                    <button class="ms-2 btn btn-warning" type="submit"
                                            onclick="showNewProposalModal()" style="font-size: 0.9rem;">
                                            <span>New Proposal</span>
                                    </button>
                                    <button class="ms-2 btn btn-success" type="submit"
                                            onclick="showNewInvoiceModal()" style="font-size: 0.9rem;">
                                            <span>New Invoice</span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </span>
                </div>
            </div>
        </nav>
    </div>

    <div class="row px-0 mx-0">
        <div id="connection_lost_modal" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger">
                        <h5 class="modal-title text-light">Warning !!!</h5>
                    </div>
                    <div class="modal-body bg-danger">
                        <span><i class="bi bi-exclamation-triangle" style="color: white;"></i><span class="text-light">&nbspConnection to the server is lost!</span></span>
                    </div>
                    <div class="modal-footer bg-danger">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="loading_modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border" role="status">
                        </div>
                        <h5 class="mt-2">Loading...</h5>
                    </div>
                </div>
            </div>
        </div>

        <div id="new_item_modal" tabindex="-1" class="modal fade" data-backdrop="static"
             xmlns="http://www.w3.org/1999/html">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 80%;" role="document">
                <div class="modal-content">
                    <form id="add_item_form" class="needs-validation" novalidate>
                        <div class="modal-header bg-secondary text-light">
                            <h5 class="modal-title">New Item</h5>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <div class="container border rounded-1 p-1">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_item_title">Title</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_item_title" class="form-control p-0" type="text"
                                                   placeholder="Item title" name="title" required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label" for="new_item_description">Description</label>
                                        </div>
                                        <div class="col-12">
                                <textarea class="container form-control p-0" id="new_item_description"
                                          name="description" rows="3" placeholder="Item description"
                                          required></textarea><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_item_price">Price ({{ currency_name
                                                }})</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_item_price" class="form-control p-0" type="number"
                                                   placeholder="Item price" name="price" required><br>
                                        </div>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please provide a valid input.
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                    onclick="$('#new_item_modal').modal('hide');">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary" onclick="addItem()">Add Item
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <datalist id="predefinedItems">
        </datalist>

        <div id="new_invoice_modal" tabindex="-1" class="modal fade" data-backdrop="static"
             xmlns="http://www.w3.org/1999/html">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 80%;" role="document">
                <div class="modal-content">
                    <form id="new_invoice_form" class="needs-validation" novalidate>
                        <div class="modal-header bg-success text-light">
                            <h5 class="modal-title">New Invoice</h5>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <div class="form-group">
                                <div class="container border rounded-1 p-1">
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_invoice_number">Invoice Number</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_invoice_number" class="form-control p-0" type="text"
                                                   placeholder="Invoice Number" name="invoice_number"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_invoice_date">Invoice Date</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_invoice_date" class="form-control p-0" type="date"
                                                   name="date"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_invoice_due_date">Due Date</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_invoice_due_date" class="form-control p-0" type="date"
                                                   name="date"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_invoice_reference_number">Reference
                                                Number</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_invoice_reference_number" class="form-control p-0"
                                                   type="text"
                                                   placeholder="Reference Number" name="invoice_reference_number"><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_invoice_customer_name">Customer
                                                Name</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_invoice_customer_name" class="form-control p-0"
                                                   placeholder="Customer Name" type="text" name="customer_name"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label" for="new_invoice_description">Description</label>
                                        </div>
                                        <div class="col-12">
                                <textarea class="container form-control p-0" id="new_invoice_description"
                                          name="description" rows="3" required></textarea><br>
                                        </div>
                                    </div>
                                </div>
                                <h2>Items</h2>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="invoiceItemsTable">
                                        <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Qty / Hrs</th>
                                            <th>Price ({{ currency_symbol }})</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody id="invoiceItemsContainer">
                                        <tr class="invoiceItem">
                                            <td class="col-4"><input type="text" class="form-control itemTitleInput"
                                                                     list="predefinedItems" name="title[]"
                                                                     required>
                                            </td>
                                            <td class="col-5"><textarea class="form-control" name="description[]"
                                                                        rows="3"></textarea>
                                            </td>
                                            <td class="col-1"><input type="number" class="form-control"
                                                                     name="quantity[]"
                                                                     min="1"
                                                                     value="1" required></td>
                                            <td class="col-1"><input type="number" class="form-control" name="price[]"
                                                                     step="1"
                                                                     min="0"
                                                                     value="0" required>
                                            </td>
                                            <td class="col-1" style="text-align: center;">
                                                <button type="button" class="btn btn-danger btn-sm removeItem">
                                                    <span><i class="bi bi-trash"></i></span>
                                                </button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <button type="button" id="addInvoiceItem" class="btn btn-primary mb-3">Add item</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                    onclick="$('#new_invoice_modal').modal('hide');">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary" onclick="generateInvoice()">Create Invoice
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="new_proposal_modal" tabindex="-1" class="modal fade" data-backdrop="static"
             xmlns="http://www.w3.org/1999/html">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 80%;" role="document">
                <div class="modal-content">
                    <form id="new_proposal_form" class="needs-validation" novalidate>
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title">New Proposal</h5>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <div class="form-group">
                                <div class="container border rounded-1 p-1">
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_proposal_number">Proposal Number</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_proposal_number" class="form-control p-0" type="text"
                                                   placeholder="Proposal Number" name="proposal_number"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_proposal_date">Invoice Date</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_proposal_date" class="form-control p-0" type="date"
                                                   name="date"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_proposal_due_date">Due Date</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_proposal_due_date" class="form-control p-0" type="date"
                                                   name="date"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_proposal_reference_number">Reference
                                                Number</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_proposal_reference_number" class="form-control p-0"
                                                   type="text"
                                                   placeholder="Reference Number" name="proposal_reference_number"><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-auto">
                                            <label class="form-label" for="new_proposal_customer_name">Customer
                                                Name</label>
                                        </div>
                                        <div class="col">
                                            <input id="new_proposal_customer_name" class="form-control p-0"
                                                   placeholder="Customer Name" type="text" name="customer_name"
                                                   required><br>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label" for="new_proposal_description">Description</label>
                                        </div>
                                        <div class="col-12">
                                <textarea class="container form-control p-0" id="new_proposal_description"
                                          name="description" rows="3" required></textarea><br>
                                        </div>
                                    </div>
                                </div>
                                <h2>Items</h2>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="proposalItemsTable">
                                        <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Qty / Hrs</th>
                                            <th>Price ({{ currency_symbol }})</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody id="proposalItemsContainer">
                                        <tr class="proposalItem">
                                            <td class="col-4"><input type="text" class="form-control itemTitleInput"
                                                                     list="predefinedItems" name="title[]"
                                                                     required>
                                            </td>
                                            <td class="col-5"><textarea class="form-control" name="description[]"
                                                                        rows="3"></textarea>
                                            </td>
                                            <td class="col-1"><input type="number" class="form-control"
                                                                     name="quantity[]"
                                                                     min="1"
                                                                     value="1" required></td>
                                            <td class="col-1"><input type="number" class="form-control" name="price[]"
                                                                     step="1"
                                                                     min="0"
                                                                     value="0" required>
                                            </td>
                                            <td class="col-1" style="text-align: center;">
                                                <button type="button" class="btn btn-danger btn-sm removeItem">
                                                    <span><i class="bi bi-trash"></i></span>
                                                </button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <button type="button" id="addProposalItem" class="btn btn-primary mb-3">Add Item</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                    onclick="$('#new_proposal_modal').modal('hide');">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary" onclick="generateProposal()">Create Proposal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="container p-0 mt-1">
            <div id="warning_notification" class="alert alert-warning ms-2 me-2 mb-0 text-danger" role="alert"
                 style="display: none">
                <span><i class="bi bi-exclamation-triangle mb-2 me-2"></i><span id="warning_notification_message">This is the warning notification message placeholder</span></span>
            </div>
            <div id="success_notification" class="alert alert-success ms-2 me-2 mb-0" role="alert"
                 style="display: none">
                <span><i class="bi bi-check-square mb-2 me-2"></i><span id="success_notification_message">This is the success notification message placeholder</span></span>
            </div>
        </div>

        {% block content %}
        {% endblock %}
    </div>

</div>

<script type="text/javascript">
    connection_lost_dialog_shown = false;
    const aboutUsModal = new bootstrap.Modal(document.getElementById('about_us_modal'), {backdrop: 'static'});

    function hideAboutUsModal() {
        aboutUsModal.hide();
    }

    function showAboutUsModal() {
        aboutUsModal.show();
    }

    $(document).ready(function() {
        $('#addInvoiceItem').click(function() {
                var newItem = $('<tr class="invoiceItem">' +
                    '<td class="col-4"><input type="text" class="form-control invoiceItemTitleInput" name="title[]" required></td>' +
                    '<td class="col-5"><textarea class="form-control" name="description[]" rows="3"></textarea></td>' +
                    '<td class="col-1"><input type="number" class="form-control" name="quantity[]" min="1" value="1" required></td>' +
                    '<td class="col-1"><input type="number" class="form-control" name="price[]" step="1" min="0" value="0" required></td>' +
                    '<td class="col-1" style="text-align: center;"><button type="button" class="btn btn-danger btn-sm removeItem"><span><i class="bi bi-trash"></i></span></button></td>' +
                    '</tr>');
                newItem.addEventListener('input', populateItemFields);
                $('#invoiceItemsContainer').append(newItem);
        });

        $('#addProposalItem').click(function() {
                var newItem = $('<tr class="proposalItem">' +
                    '<td class="col-4"><input type="text" class="form-control" name="title[]" required></td>' +
                    '<td class="col-5"><textarea class="form-control" name="description[]" rows="3"></textarea></td>' +
                    '<td class="col-1"><input type="number" class="form-control" name="quantity[]" min="1" value="1" required></td>' +
                    '<td class="col-1"><input type="number" class="form-control" name="price[]" step="1" min="0" value="0" required></td>' +
                    '<td class="col-1" style="text-align: center;"><button type="button" class="btn btn-danger btn-sm removeItem"><span><i class="bi bi-trash"></i></span></button></td>' +
                    '</tr>');
                newItem.addEventListener('input', populateItemFields);
                $('#proposalItemsContainer').append(newItem);
        });

        $(document).on('click', '.removeItem', function() {
            $(this).closest('tr').remove();
        });

        // Add event listener for selection
        // Select all elements with the classname using querySelectorAll.
        let elements = document.querySelectorAll('.itemTitleInput');

        for(let i=0; i<elements.length; i++) {
            // Add an event listener to each selected element.
            elements[i].addEventListener('input', populateItemFields);
        }
    });

    $(document).ajaxError(function( event, request, settings ) {
        //When XHR Status code is 0 there is no connection with the server
        if (request.status == 0){
            if (!connection_lost_dialog_shown) {
                $('#connection_lost_modal').modal('show');
                connection_lost_dialog_shown = true;
            }
        }
    });

    function populateItemFields(e) {
        const selectedValue = e.target.value;
        if (selectedValue.trim() !== '') {
          const options = document.getElementById('predefinedItems').options;
          for (let i = 0; i < options.length; i++) {
            if (options[i].value === selectedValue) {
                trElement = e.target.parentNode.parentNode;
                descriptionElement = trElement.querySelector('[name="description[]"]');
                priceElement = trElement.querySelector('[name="price[]"]');

                descriptionElement.value = options[i].description;
                priceElement.value = options[i].price;

                break;
            }
          }
        }
    }

    function loadNewTabWithInvoiceID(invoice_id, show_print_dialog) {
        var url = '/view_invoice?invoice_id=' + encodeURIComponent(invoice_id);

        if (show_print_dialog) {
            url += '&show_print_dialog'
        }

        // Load the invoice with the specified number in a new tab
        let newTab = window.open(url, '_blank');

        // Check if the new tab was successfully opened and focus on it.
        if (newTab) {
            newTab.focus();
        }
    }

    function loadNewTabWithProposalID(proposal_id, show_print_dialog) {
        var url = '/view_proposal?proposal_id=' + encodeURIComponent(proposal_id);

        if (show_print_dialog) {
            url += '&show_print_dialog'
        }

        // Load the invoice with the specified number in a new tab
        let newTab = window.open(url, '_blank');

        // Check if the new tab was successfully opened and focus on it.
        if (newTab) {
            newTab.focus();
        }
    }

    function showNewItemModal() {
        $('#new_item_modal').modal('show');

        // clear up the form fields
        $('#new_item_title').val('');
        $('#new_item_description').val('');
        $('#new_item_price').val('');
    }

    function showNewInvoiceModal() {
        $('#loading_modal').modal('show');

        // clear up the form fields
        $('#new_invoice_number').val('');
        $('#new_invoice_date').val('');
        $('#new_invoice_due_date').val('');
        $('#new_invoice_customer_name').val('');
        $('#new_invoice_reference_number').val('');
        $('#new_invoice_description').val('');

        setNewInvoiceDate();

        $.ajax({
            type: 'GET',
            url: '/new_invoice_number',
            success: function(data) {
                $('#loading_modal').modal('hide');
                $('#new_invoice_number').val(data);

                $('#new_invoice_modal').modal('show');
            },
            error: function (error) {
                $('#loading_modal').modal('hide');
                notify_warning('Error while retrieving a new invoice number! Reason: ' + error);
            }
        });

        $('#invoiceItemsContainer tr.item:not(:first)').remove();

        // Clear the inputs of the first row
        var firstRow = $('#invoiceItemsContainer tr.item:first');
        firstRow.find('input[type="text"]').val('');
        firstRow.find('input[name="quantity[]"]').val('1');
        firstRow.find('input[name="price[]"]').val('0');

        $.ajax({
            type: 'GET',
            url: '/get_items_data',
            success: function(data) {
                const datalist = document.getElementById('predefinedItems');

                // Clear existing options
                datalist.innerHTML = '';

                // Add new options from the API response
                data.forEach(item => {
                  const option = document.createElement('option');
                  option.id = item.id;
                  option.value = item.title;
                  option.description = item.description;
                  option.price = item.price;
                  datalist.appendChild(option);
                });
            },
            error: function (error) {
                notify_warning('Error while populating predefined items! Reason: ' + error);
            }
        });
    }

    function showNewProposalModal() {
        $('#loading_modal').modal('show');

        // clear up the form fields
        $('#new_proposal_number').val('');
        $('#new_proposal_date').val('');
        $('#new_proposal_due_date').val('');
        $('#new_proposal_customer_name').val('');
        $('#new_proposal_reference_number').val('');
        $('#new_proposal_description').val('');

        setNewProposalDate();

        $.ajax({
            type: 'GET',
            url: '/new_proposal_number',
            success: function(data) {
                $('#loading_modal').modal('hide');
                $('#new_proposal_number').val(data);

                $('#new_proposal_modal').modal('show');
            },
            error: function (error) {
                $('#loading_modal').modal('hide');
                notify_warning('Error while retrieving a new proposal number! Reason: ' + error);
            }
        });

        $('#proposalItemsContainer tr.item:not(:first)').remove();

        // Clear the inputs of the first row
        var firstRow = $('#proposalItemsContainer tr.item:first');
        firstRow.find('input[type="text"]').val('');
        firstRow.find('input[name="quantity[]"]').val('1');
        firstRow.find('input[name="price[]"]').val('0');

        $.ajax({
            type: 'GET',
            url: '/get_items_data',
            success: function(data) {
                const datalist = document.getElementById('predefinedItems');

                // Clear existing options
                datalist.innerHTML = '';

                // Add new options from the API response
                data.forEach(item => {
                  const option = document.createElement('option');
                  option.id = item.id;
                  option.value = item.title;
                  option.description = item.description;
                  option.price = item.price;
                  datalist.appendChild(option);
                });
            },
            error: function (error) {
                notify_warning('Error while populating predefined items! Reason: ' + error);
            }
        });
    }

    function addItem() {
        form = document.getElementById('add_item_form');
        if (!form.checkValidity())
            return;

        $('#loading_modal').modal('show');

        $.ajax({
            url: '/add_item',
            method: 'POST',
            data: {
                title: $('#new_item_title').val(),
                description: $('#new_item_description').val(),
                price: $('#new_item_price').val()
            },
            success: function(item_id) {
                $('#loading_modal').modal('hide');
                if (!item_id)
                    notify_warning('Error while creating a new item');
                else {
                    notify_success('New item successfully created!');

                    // hide the create item form
                    $('#new_item_modal').modal('hide');
                }
            },
            error: function (error) {
                $('#loading_modal').modal('hide');
                notify_warning('Error while creating a new item! Reason: ' + error);
            }
        });
    }

    function generateInvoice() {
        form = document.getElementById('new_invoice_form');
        if (!form.checkValidity())
            return;

        $('#loading_modal').modal('show');

        var items = [];
        $('.invoiceItem').each(function() {
            var item = {
                title: $(this).find('input[name="title[]"]').val(),
                description: $(this).find('textarea[name="description[]"]').val(),
                quantity: parseInt($(this).find('input[name="quantity[]"]').val()),
                price: parseFloat($(this).find('input[name="price[]"]').val()),
                amount: parseInt($(this).find('input[name="quantity[]"]').val()) * parseFloat($(this).find('input[name="price[]"]').val())
            };
            items.push(item);
        });

        $.ajax({
            url: '/generate_invoice',
            method: 'POST',
            data: {
                invoice_number: $('#new_invoice_number').val(),
                invoice_date: $('#new_invoice_date').val(),
                due_date: $('#new_invoice_due_date').val(),
                customer_name: $('#new_invoice_customer_name').val(),
                reference_number: $('#new_invoice_reference_number').val(),
                description: $('#new_invoice_description').val(),
                items: JSON.stringify(items)
            },
            success: function(invoice_id) {
                $('#loading_modal').modal('hide');
                if (!invoice_id)
                    notify_warning('Error while creating a new invoice');
                else {
                    notify_success('New invoice successfully created!');

                    // hide the create invoice form
                    $('#new_invoice_modal').modal('hide');

                    // show the newly created invoice
                    loadNewTabWithInvoiceID(invoice_id, true);
                }
            },
            error: function (error) {
                $('#loading_modal').modal('hide');
                notify_warning('Error while creating a new invoice! Reason: ' + error);
            }
        });
    }

    function generateProposal() {
        form = document.getElementById('new_proposal_form');
        if (!form.checkValidity())
            return;

        $('#loading_modal').modal('show');

        var items = [];
        $('.proposalItem').each(function() {
            var item = {
                title: $(this).find('input[name="title[]"]').val(),
                description: $(this).find('textarea[name="description[]"]').val(),
                quantity: parseInt($(this).find('input[name="quantity[]"]').val()),
                price: parseFloat($(this).find('input[name="price[]"]').val()),
                amount: parseInt($(this).find('input[name="quantity[]"]').val()) * parseFloat($(this).find('input[name="price[]"]').val())
            };
            items.push(item);
        });

        $.ajax({
            url: '/generate_proposal',
            method: 'POST',
            data: {
                proposal_number: $('#new_proposal_number').val(),
                proposal_date: $('#new_proposal_date').val(),
                due_date: $('#new_proposal_due_date').val(),
                customer_name: $('#new_proposal_customer_name').val(),
                reference_number: $('#new_proposal_reference_number').val(),
                description: $('#new_proposal_description').val(),
                items: JSON.stringify(items)
            },
            success: function(proposal_id) {
                $('#loading_modal').modal('hide');
                if (!proposal_id)
                    notify_warning('Error while creating a new proposal');
                else {
                    notify_success('New proposal successfully created!');

                    // hide the create invoice form
                    $('#new_proposal_modal').modal('hide');

                    // show the newly created proposal
                    loadNewTabWithProposalID(proposal_id, true);
                }
            },
            error: function (error) {
                $('#loading_modal').modal('hide');
                notify_warning('Error while creating a new proposal! Reason: ' + error);
            }
        });
    }

    // Function to set today's date
    function setNewInvoiceDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        today = yyyy + '-' + mm + '-' + dd;
        $('#new_invoice_date').val(today);

        // Compute the due date
        var dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + {{ invoice_valid_for_days }});
        var dd = String(dueDate.getDate()).padStart(2, '0');
        var mm = String(dueDate.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = dueDate.getFullYear();

        dueDate = yyyy + '-' + mm + '-' + dd;
        $('#new_invoice_due_date').val(dueDate);
    }

    // Function to set today's date
    function setNewProposalDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        today = yyyy + '-' + mm + '-' + dd;
        $('#new_proposal_date').val(today);

        // Compute the due date
        var dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + {{ invoice_valid_for_days }});
        var dd = String(dueDate.getDate()).padStart(2, '0');
        var mm = String(dueDate.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = dueDate.getFullYear();

        dueDate = yyyy + '-' + mm + '-' + dd;
        $('#new_proposal_due_date').val(dueDate);
    }

    function notify_success(message) {
        $('#success_notification_message').html(message);
        $("#success_notification").fadeIn();
        setTimeout(function () {
            $("#success_notification").fadeOut();
        }, 5000);
    }

    function notify_warning(message) {
        $('#warning_notification_message').html(message);
        $("#warning_notification").fadeIn();
        setTimeout(function () {
            $("#warning_notification").fadeOut();
        }, 5000);
    }

    (function() {
      'use strict';
      window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
</script>

</body>
</html>
