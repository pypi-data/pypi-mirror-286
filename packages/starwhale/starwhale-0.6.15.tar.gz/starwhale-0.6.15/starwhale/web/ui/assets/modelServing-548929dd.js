import{r as c,u as B,j as e,B as z,N as I,E as H,h as Q,M as V,d as W,k as G,a6 as O,n as Y,t as X,R as E,a7 as Z,_ as N,o as q,a9 as J,U as ee,Q as te,V as ne,S as se,W as oe,X as ae,Y as re,aa as ie}from"./__uno-75844fc7.js";import{u as le,a as ce,b as de,c as pe,C as ue,I as R,d as xe,e as he,S as me,f as fe,L as A,g as P}from"./useSubmitHandler-226dbd7a.js";import"./index-5003e8cb.js";var D=(o=>(o.LLM_CHAT="llm_chat",o))(D||{});const y=15;function ge({scrollRef:o,inputRef:l,setAutoScroll:i,useChatStore:x,session:t}){const a=x(),{job:r}=t.serving??{},[d]=B(),h=!1,[,p]=c.useState(!0),m=c.useMemo(()=>t.mask.hideContext?[]:(t.mask.context??[])?.slice(),[t.mask.context,t.mask.hideContext]),u=c.useMemo(()=>m.concat(t.messages).concat([]),[m,h,t.messages]),[f,w]=c.useState(Math.max(0,u.length-y));function j(s){s=Math.min(u.length-y,s),s=Math.max(0,s),w(s)}const C=c.useMemo(()=>{const s=Math.min(f+3*y,u.length);return u.slice(f,s)},[f,u]),_=s=>{c.startTransition(()=>{const v=s.scrollTop+s.clientHeight,M=s.clientHeight,F=s.scrollTop<=M,k=v>=s.scrollHeight-M,K=v>=s.scrollHeight-10,U=f-y,$=f+y;F&&!k?j(U):k&&j($),p(K)})},[g,T]=c.useState(!1),[b,n]=c.useState(!1),S=xe(async()=>{await a.checkSessionApiById(t.id)&&(S(),T(!0))},1e3);return he({leftTime:30*1e3,onEnd:()=>{g||n(!0),S()}}),!t||!r?e.jsx(I,{type:"empty"}):e.jsxs("div",{className:"chat rounded-4px border-1 border-[#cfd7e6] h-full overflow-hidden flex flex-col pb-15px bg-white",children:[e.jsx("div",{className:"chat-title flex lh-none h-40px bg-[#eef1f6] px-10px items-center",children:e.jsx(H,{disabled:!t?.serving,icon:"setting",styleas:["menuoption","nopadding","iconnormal",t?.serving?void 0:"icondisable"],onClick:()=>a.onSessionEditParamsShow(r.id)})}),e.jsxs("div",{className:"chat-body flex-1 overflow-auto overflow-x-hidden p-10px pb-0px relative overscroll-none flex gap-20px flex-col min-w-0 h-full bg-white",ref:o,onScroll:s=>_(s.currentTarget),onMouseDown:()=>l.current?.blur(),onTouchStart:()=>{l.current?.blur(),i(!1)},children:[!g&&!b&&e.jsx(I,{children:d("ft.online_eval.api.loading")}),!g&&b&&e.jsx(I,{type:"center",children:e.jsxs(Q,{$style:{color:"rgba(2,16,43,0.20)"},children:[d("ft.online_eval.api.failed")," "]})}),g&&C.map(s=>{const v=s.role==="user";return e.jsx(c.Fragment,{children:e.jsx("div",{className:`${v?"chat-message-user ":"chat-message"} `,children:e.jsx("div",{className:`chat-message-container  rounded-4px border-1 px-10px py-4px break-words text-wrap inline-block ${v?"bg-white":"bg-[#EBF1FF]"}`,children:e.jsx("div",{className:"chat-message-item",children:e.jsx("div",{children:s.content})})})})},s.id)})]})]})}function Se({useChatStore:o}){const l=o(),[i]=B(),[x,t]=c.useReducer(r=>r+1,0),a=l.getSessionById(l?.editingSessionId);return a?e.jsxs(V,{isOpen:!!l.editingSessionId,onClose:()=>l.onSessionEditParamsHide(),closeable:!0,animate:!0,autoFocus:!0,children:[e.jsx(W,{children:a?.serving?.job?.modelName}),e.jsx(G,{$style:{paddingBottom:"20px"},children:e.jsxs("div",{className:"py-20px border-t-1px border-b-1px",children:[e.jsxs("div",{className:" mb-20px flex justify-between",children:[i("ft.online_eval.parameter.title"),e.jsx(H,{kind:"secondary",icon:"reset",onClick:()=>{l.onSessionEditParamsReset(a.id),t()},children:i("ft.online_eval.parameter.reset")})]}),e.jsx("div",{className:"gap-20px",children:a?.serving?.apiSpec?.components?.map(({componentValueSpecFloat:r,componentValueSpecInt:d,...h})=>{const p=r??d,m=a.params?.[h.name]??p?.defaultVal??0;return p?e.jsxs("div",{className:"grid grid-cols-[100px_1fr_40px]",children:[e.jsx("p",{className:"pt-5px break-words",children:h.name}),e.jsx(me,{overrides:{ThumbValue:{style:{backgroundColor:"#2B65D9",width:"50px !important",height:"32px !important",position:"relative",top:"-30px",textAlign:"center",display:"flex",justifyContent:"center",alignItems:"center",...O("50px"),...Y("0px","12px","0px","12px")}},InnerThumb:{style:{backgroundColor:"#2B65D9",width:"1px"}},Thumb:{style:{width:"16px",height:"16px",borderColor:"#2B65D9",backgroundColor:"#fff",borderWidth:"2px"}}},initialState:{value:[m]},min:p?.min??void 0,max:p?.max??void 0,step:p?.step??void 0,onFinalChange:({value:u})=>{l.onSessionEditParams(a.id,{[h.name]:u[0]})}}),e.jsx("p",{className:"pt-5px break-words",children:m})]},[h.name,x].join("-")):null})})]})})]}):null}function be({useStore:o}){const l=o(),i=c.useRef(null),x=le(),[t,a]=c.useState(""),{submitKey:r,shouldSubmit:d}=ce(),{scrollDomToBottom:h,setAutoScroll:p,scrollRefs:m}=x,u={inputRef:i,...x,userInput:t,setUserInput:a},[f]=B(),[w,j]=c.useState(2),C=de();pe(()=>{const n=i.current?fe(i.current):1,S=Math.min(5,Math.max(1,n));j(S)},[t],{wait:100,leading:!0,trailing:!0});const _=n=>{a(n)},g=n=>{n.trim()!==""&&(a(""),i.current?.focus(),p(!0),l.onUserInput(R.llm_chat,n),localStorage.setItem(A,t))},T=n=>{if(n.key==="ArrowUp"&&t.length<=0&&!(n.metaKey||n.altKey||n.ctrlKey)){a(localStorage.getItem(A)??""),n.preventDefault();return}d(n)&&(g(t),n.preventDefault())};function b(){h()}return e.jsxs("div",{className:"chat-group flex flex-col overflow-hidden",children:[e.jsx("div",{className:"flex overflow-x-auto gap-20px mb-10px text-nowrap flex-nowrap pb-10px mx-auto",children:e.jsx(ue,{defaultConstraints:[1e3,500],children:l.sessions.filter(n=>n.show&&n.serving?.type===R.llm_chat).map((n,S)=>n.id?e.jsx(ge,{...u,useChatStore:o,session:n,scrollRef:s=>{m.current[S]=s}},n.id):null)})}),e.jsxs("div",{className:"chat-input-panel-inner w-full border-1 flex flex-1 py-6px px-12px items-end rounded-4px bg-white",children:[e.jsx("textarea",{ref:i,className:"chat-input w-full h-full resize-none lh-32px outline-none",placeholder:f("ft.online_eval.enter.placeholder",[r]),onInput:n=>_(n.currentTarget.value),value:t,onKeyDown:T,onFocus:b,onClick:b,rows:w,style:{fontSize:C.fontSize}}),e.jsx("div",{className:"flex-shrink-0 lh-none",children:e.jsx(z,{onClick:()=>g(t),children:"Enter"})})]}),e.jsx(Se,{useChatStore:o})]})}const L=window?.starwhaleConfig?.root??"",ve=async()=>{const{data:o}=await q.get(`${L}/api/spec`);return o};function ye(){const o=X("spec",ve),l=P(),[i,x]=E.useState(),[t,a]=E.useState();return c.useEffect(()=>{if(!o.data)return;const r=o.data.apis[0];l.newOrUpdateSession({job:{id:"client"},type:r?.inference_type,exposedLink:{link:`${L}/`,type:"WEB_HANDLER",name:"llm_chat"},apiSpec:o.data.apis[0]}),x(o.data),a(o.data.apis[0])},[o.data]),e.jsxs("div",{children:[(i?.apis?.length??0)>1&&e.jsx(Z,{options:N.map(i?.apis,r=>({id:r.inference_type,label:r.inference_type})),value:[{id:t?.inference_type,label:t?.inference_type}],onChange:({option:r})=>{if(!r||!i?.apis)return;const d=N.find(i.apis,{inference_type:r.id});d&&a(d)}}),t?.inference_type===D.LLM_CHAT&&e.jsx(be,{useStore:P})]})}J();function je(){return e.jsx(ee,{client:new te,children:e.jsx(ne,{value:new se,children:e.jsx(oe,{theme:ae,children:e.jsx(re,{locale:{},children:e.jsx(ye,{})})})})})}const we=ie.createRoot(document.getElementById("root"));we.render(e.jsx(je,{}));
