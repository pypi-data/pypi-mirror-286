var _=(n,a,r)=>new Promise((e,i)=>{var d=s=>{try{u(r.next(s))}catch(c){i(c)}},t=s=>{try{u(r.throw(s))}catch(c){i(c)}},u=s=>s.done?e(s.value):Promise.resolve(s.value).then(d,t);u((r=r.apply(n,a)).next())});import{s as $,u as R,t as b,_ as M}from"../index.js";import{u as Y,a as D,l as Z,m as K,v as O,n as X,e as ee,b as te,c as ae,d as oe}from"./elementplus-B-iJGUzg.js";import{m as V,a as f,P as F,u as o,p as y,q as k,U as m,O as h,S as E,t as v,T,D as se,Z as B,f as G,J as L,V as U,M as I,R as ne,b as le,e as re}from"./vue-CFoKlS7q.js";function ce(n){return _(this,null,function*(){const a=new FormData;return a.append("repo_url",n.repo_url),a.append("branch",n.branch),n.files.forEach(r=>{a.append("files",r)}),$({url:"/upload",method:"post",headers:{"Content-Type":"multipart/form-data"},data:a})})}function ie(n){return _(this,null,function*(){return $({url:"/sync",method:"post",headers:{"Content-Type":"application/json"},data:n})})}const ue={"element-loading-text":"Syncing...",class:"xs:w-[320px] w-[800px] xs:h-[300px] h-[100%] flex flex-col gap-2 p-2 justify-center items-center"},de=v("div",{class:"el-upload__text"},[E(" Drop file here or "),v("em",null,"click to select")],-1),pe=v("div",{class:"el-upload__tip"}," Please select QRCode image files ",-1),fe={class:"file-count"},_e=V({__name:"QrDecoder",setup(n){const a=R(),r=f(!1),e=f([]);function i(){return _(this,null,function*(){const d=e.value.filter(t=>!!t.raw).map(t=>t.raw);if(d.length===0){b({type:"error",message:"Please select files"});return}r.value=!0;try{const t=yield ce({files:d,repo_url:a.repo.url,branch:a.repo.branch});console.log("res",t),t.code===0?(b({type:"success",message:"Git sync success"}),e.value=[]):b({type:"error",message:"Git sync failed"})}catch(t){console.error("error",t),b({type:"error",message:"Git sync failed"})}r.value=!1})}return(d,t)=>{const u=D,s=Z,c=K,p=O;return F((y(),k("div",ue,[m(u,{type:"primary",onClick:i},{default:h(()=>[E(" Start to sync ")]),_:1}),m(c,{"file-list":o(e),"onUpdate:fileList":t[0]||(t[0]=g=>se(e)?e.value=g:null),class:"upload-box xs:max-h-[90%] overflow-hidden w-full",drag:"",action:"#",method:"post",multiple:!0,"auto-upload":!1},{tip:h(()=>[pe,v("div",fe,[v("strong",null,T(o(e).length),1),E(" files selected ")])]),default:h(()=>[m(s,{class:"el-icon--upload"},{default:h(()=>[m(o(Y))]),_:1}),de]),_:1},8,["file-list"])])),[[p,o(r)]])}}});function me(){return _(this,null,function*(){const n=yield M(()=>import("./wasm-CEaAGFph.js"),[]).then(r=>r.cv);yield n.ready;const a=yield ge(n);return{cv:n,qrcode_detector:a}})}let P;function ve(){return _(this,null,function*(){return P||(P=me()),P})}function he(r){return _(this,arguments,function*(n,a={}){const{cv:e,qrcode_detector:i}=yield ve(),d=e.imread(n,e.IMREAD_GRAYSCALE),t=new e.MatVector,u=i.detectAndDecode(d,t),s=t.get(0),c=s?{x:s.floatAt(0),y:s.floatAt(1),width:s.floatAt(4)-s.floatAt(0),height:s.floatAt(5)-s.floatAt(1)}:void 0;let p;if(c&&a.includeRectCanvas){p=document.createElement("canvas");const g=d.roi(new e.Rect(c.x,c.y,c.width,c.height));e.imshow(p,g),g.delete()}return d.delete(),{text:u.get(0),rect:c,rectCanvas:p}})}function ge(n){return _(this,null,function*(){const a=yield M(()=>import("./wasm-CEaAGFph.js"),[]);return n.FS_createDataFile("/","detect.prototxt",a.detect_prototxt,!0,!1,!1),n.FS_createDataFile("/","detect.caffemodel",a.detect_caffemodel,!0,!1,!1),n.FS_createDataFile("/","sr.prototxt",a.sr_prototxt,!0,!1,!1),n.FS_createDataFile("/","sr.caffemodel",a.sr_caffemodel,!0,!1,!1),new n.wechat_qrcode_WeChatQRCode("detect.prototxt","detect.caffemodel","sr.prototxt","sr.caffemodel")})}const ye={"element-loading-text":"Syncing...",class:"qr-scanner w-full h-full flex justify-start items-start flex-col gap-2 p-2 xs:w-[96%] w-[96%]"},we=v("br",null,null,-1),xe={key:0},Se={key:1},be={class:"dialog-footer"},Ee=V({__name:"QrScanner",setup(n){const a=R(),r=f(!1),e=f(!1);f("");const i=f(null),d=f(null),t=f(null),u=B({width:512,height:512}),s=f(0),c=f(0),p=f([]),g=f(!1),A=f(!1),C=f(!1),j=G(()=>p.value.filter(l=>!!l).length);function Q(l){return _(this,null,function*(){var S;if(l){e.value=!1,clearInterval(d.value),(S=t.value)==null||S.getTracks().forEach(w=>{w.stop()}),console.log("code",l);const x=l.split(":");if(s.value=parseInt(x[0]),c.value=parseInt(x[1]),p.value[c.value]?A.value=!0:A.value=!1,p.value[c.value]=x[2],j.value===s.value){g.value=!1;const w=p.value.join("");console.log("result",w),C.value=!0}else g.value=!0}})}function N(){return _(this,null,function*(){var w;if(!i.value)return;const l=document.createElement("canvas");l.width=i.value.videoWidth,l.height=i.value.videoHeight,l.getContext("2d").drawImage(i.value,0,0,l.width,l.height);const x=yield he(l);Q((w=x.text)!=null?w:"")})}function z(){return _(this,null,function*(){var l;console.log("stop scan"),e.value=!1,clearInterval(d.value),(l=t.value)==null||l.getTracks().forEach(S=>{S.stop()})})}function q(){return _(this,null,function*(){if(console.log("start scan"),!!i.value){e.value=!0;try{t.value=yield navigator.mediaDevices.getUserMedia({audio:!1,video:{width:u.width,height:u.height,facingMode:{exact:"environment"}}})}catch(l){if(l.name==="OverconstrainedError")console.log("[OverconstrainedError] Can not use rear camera."),t.value=yield navigator.mediaDevices.getUserMedia({video:{width:u.width,height:u.height},audio:!1});else throw l}i.value.srcObject=t.value,i.value.play(),d.value=window.setInterval(N,200)}})}function W(){return _(this,null,function*(){console.log("start sync");const l=yield ie({data:p.value,repo_url:a.repo.url,branch:a.repo.branch});console.log("res",l),l.code===0?b({message:"Sync success",type:"success"}):b({message:"Sync failed",type:"error"}),p.value=[],s.value=0,c.value=0,g.value=!1,C.value=!1,e.value=!1})}function H(){C.value?W():q()}return(l,S)=>{const x=X,w=ee,J=O;return F((y(),k("div",ye,[F(v("div",{class:"top flex justify-center items-center relative w-full h-full",style:L({zIndex:o(e)?0:1})},[m(o(D),{type:"primary",onClick:q},{default:h(()=>[E("Start Scan")]),_:1})],4),[[U,!o(e)]]),F(v("div",{class:"video-wrapper left-0 top-0 flex justify-center items-center w-full h-full",style:L({position:o(e)?"absolute":"relative",backgroundColor:o(e)?"rgba(0, 0, 0, 0.5)":"transparent"})},[v("video",{ref_key:"videoRef",ref:i,class:"w-[100vw] h-[100vw]",autoplay:""},null,512),m(o(D),{type:"warning",class:"absolute bottom-20",onClick:z},{default:h(()=>[E(" Stop Scan ")]),_:1})],4),[[U,o(e)]]),m(w,{"model-value":o(g)&&!o(e)||o(C),title:"Tips",width:"500","align-center":""},{footer:h(()=>[v("div",be,[m(o(D),{type:"primary",onClick:H},{default:h(()=>[E(" Confirm ")]),_:1})])]),default:h(()=>[v("p",null,[v("span",null," Scan progress: "+T(o(j))+" / "+T(o(s)),1),we,o(C)?(y(),k("span",xe," Scan finished, confirm to submit sync? ")):(y(),k("span",Se," Continue to scan? ")),o(A)?(y(),I(x,{key:2,title:"Scan same qrcode",type:"error",effect:"dark"})):ne("",!0)])]),_:1},8,["model-value"])])),[[J,o(r)]])}}}),Ce=V({__name:"GitProject",setup(n){const a=R(),r=f(null),e=B({url:"",branch:"main"}),i={url:[{required:!0,message:"Please input url",trigger:"blur"}],branch:[{required:!0,message:"Please input branch",trigger:"blur"}]};return le(()=>e,()=>{console.log("form:",e),e.url&&e.branch&&a.updateRepo(e)},{deep:!0}),re(()=>{a.repo.url&&(e.url=a.repo.url,e.branch=a.repo.branch)}),(d,t)=>{const u=te,s=ae,c=oe;return y(),I(c,{ref_key:"gitFormRef",ref:r,model:o(e),rules:i},{default:h(()=>[m(s,{label:"Git Url",prop:"url"},{default:h(()=>[m(u,{modelValue:o(e).url,"onUpdate:modelValue":t[0]||(t[0]=p=>o(e).url=p),name:"url",placeholder:"Please input"},null,8,["modelValue"])]),_:1}),m(s,{label:"Branch",prop:"branch"},{default:h(()=>[m(u,{modelValue:o(e).branch,"onUpdate:modelValue":t[1]||(t[1]=p=>o(e).branch=p),name:"branch",placeholder:"Please input"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])}}}),ke={class:"page-container w-full h-full flex flex-col justify-start items-center"},Ve=V({__name:"Index",setup(n){const a=R(),r=G(()=>a.syncType);return(e,i)=>{const d=Ce,t=Ee,u=_e;return y(),k("div",ke,[m(d,{class:"w-100"}),o(r)==="scan"?(y(),I(t,{key:0})):(y(),I(u,{key:1}))])}}});export{Ve as default};
